{
  if (isLeaf() || isPreTerminal()) {
    return this;
  }
  Tree[] kids=children();
  List<Tree> newChildren=new ArrayList<Tree>(kids.length);
  for (int c=0; c < kids.length; c++) {
    Tree child=kids[c];
    if (child.isLeaf() || child.isPreTerminal()) {
      newChildren.add(child);
    }
 else {
      Tree newChild=child.flatten(tf);
      if (label().equals(newChild.label())) {
        newChildren.addAll(newChild.getChildrenAsList());
      }
 else {
        newChildren.add(newChild);
      }
    }
  }
  return tf.newTreeNode(label(),newChildren);
}
