{
  double[] xtest=new double[initial.length];
  this.maxTime=msPerTest;
  if (!(function instanceof AbstractStochasticCachingDiffFunction)) {
    throw new UnsupportedOperationException();
  }
  AbstractStochasticCachingDiffFunction dfunction=(AbstractStochasticCachingDiffFunction)function;
  List<Pair<Double,Double>> res=new ArrayList<Pair<Double,Double>>();
  Pair<Double,Double> best=new Pair<Double,Double>(lower,Double.POSITIVE_INFINITY);
  Pair<Double,Double> low=new Pair<Double,Double>(lower,Double.POSITIVE_INFINITY);
  Pair<Double,Double> high=new Pair<Double,Double>(upper,Double.POSITIVE_INFINITY);
  Pair<Double,Double> cur=new Pair<Double,Double>();
  Pair<Double,Double> tmp=new Pair<Double,Double>();
  List<Double> queue=new ArrayList<Double>();
  queue.add(lower);
  queue.add(upper);
  boolean toContinue=true;
  this.numPasses=10000;
  do {
    System.arraycopy(initial,0,xtest,0,initial.length);
    if (queue.size() != 0) {
      cur.first=queue.remove(0);
    }
 else {
      cur.first=0.5 * (low.first() + high.first());
    }
    ps.set(cur.first());
    System.err.println("");
    System.err.println("About to test with batch size:  " + bSize + "  gain: "+ gain+ " and  "+ ps.toString()+ " set to  "+ cur.first());
    xtest=this.minimize(function,1e-100,xtest);
    if (Double.isNaN(xtest[0])) {
      cur.second=Double.POSITIVE_INFINITY;
    }
 else {
      cur.second=dfunction.valueAt(xtest);
    }
    if (cur.second() < best.second()) {
      copyPair(best,tmp);
      copyPair(cur,best);
      if (tmp.first() > best.first()) {
        copyPair(tmp,high);
      }
 else {
        copyPair(tmp,low);
      }
      queue.add(0.5 * (cur.first() + high.first()));
    }
 else     if (cur.first() < best.first()) {
      copyPair(cur,low);
    }
 else     if (cur.first() > best.first()) {
      copyPair(cur,high);
    }
    if (Math.abs(low.first() - high.first()) < TOL) {
      toContinue=false;
    }
    res.add(new Pair<Double,Double>(cur.first(),cur.second()));
    System.err.println("");
    System.err.println("Final value is: " + nf.format(cur.second()));
    System.err.println("Optimal so far using " + ps.toString() + " is: "+ best.first());
  }
 while (toContinue);
  System.err.println("-------------");
  System.err.println(" RESULTS          ");
  System.err.println(ps.getClass().toString());
  System.err.println("-------------");
  System.err.println("  val    ,    function after " + msPerTest + " ms");
  for (int i=0; i < res.size(); i++) {
    System.err.println(res.get(i).first() + "    ,    " + res.get(i).second());
  }
  System.err.println("");
  System.err.println("");
  return best.first();
}
