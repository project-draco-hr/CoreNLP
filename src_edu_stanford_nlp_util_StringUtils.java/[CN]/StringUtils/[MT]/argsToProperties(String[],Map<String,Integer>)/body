{
  Properties result=new Properties();
  List<String> remainingArgs=new ArrayList<String>();
  for (int i=0; i < args.length; i++) {
    String key=args[i];
    if (key.length() > 0 && key.charAt(0) == '-') {
      if (key.length() > 1 && key.charAt(1) == '-')       key=key.substring(2);
 else       key=key.substring(1);
      Integer maxFlagArgs=flagsToNumArgs.get(key);
      int max=maxFlagArgs == null ? 1 : maxFlagArgs;
      int min=maxFlagArgs == null ? 0 : maxFlagArgs;
      List<String> flagArgs=new ArrayList<String>();
      for (int j=0; j < max && i + 1 < args.length && (j < min || args[i + 1].isEmpty() || args[i + 1].charAt(0) != '-'); i++, j++) {
        flagArgs.add(args[i + 1]);
      }
      if (flagArgs.isEmpty()) {
        result.setProperty(key,"true");
      }
 else {
        result.setProperty(key,join(flagArgs," "));
        if (key.equalsIgnoreCase(PROP) || key.equalsIgnoreCase(PROPS) || key.equalsIgnoreCase(PROPERTIES)|| key.equalsIgnoreCase(ARGUMENTS)|| key.equalsIgnoreCase(ARGS)) {
          try {
            BufferedReader reader=IOUtils.readerFromString(result.getProperty(key));
            result.remove(key);
            result.load(reader);
            for (            String propKey : result.stringPropertyNames()) {
              String newVal=result.getProperty(propKey);
              result.setProperty(propKey,newVal.trim());
            }
            reader.close();
          }
 catch (          IOException e) {
            String msg="argsToProperties could not read properties file: " + result.getProperty(key);
            result.remove(key);
            throw new RuntimeIOException(msg,e);
          }
        }
      }
    }
 else {
      remainingArgs.add(args[i]);
    }
  }
  if (!remainingArgs.isEmpty()) {
    result.setProperty("",join(remainingArgs," "));
  }
  if (result.containsKey(PROP)) {
    String file=result.getProperty(PROP);
    result.remove(PROP);
    Properties toAdd=argsToProperties(new String[]{"-prop",file});
    for (Enumeration<?> e=toAdd.propertyNames(); e.hasMoreElements(); ) {
      String key=(String)e.nextElement();
      String val=toAdd.getProperty(key);
      if (!result.containsKey(key)) {
        result.setProperty(key,val);
      }
    }
  }
  return result;
}
