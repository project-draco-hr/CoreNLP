{
  double p=0.0;
  entityList=extractEntities(sequence,wordDoc,tagIndex,classIndex,backgroundSymbolIndex);
  for (  Entity entity : entityList) {
    int length=entity.wordsSize;
    int tag1=entity.type;
    for (    Entity match : entity.exactMatch) {
      int tag2=match.type;
      double factor=entityMatrix[tag1][tag2] + entityMatrix[tag2][tag1];
      if (tag1 == tag2) {
        if (flags.matchNERIncentive)         factor*=-1;
 else         factor=0;
      }
      p+=length * factor;
    }
    for (    Entity match : entity.subMatch) {
      int olength=match.wordsSize;
      int tag2=match.type;
      double factor=subEntityMatrix[tag1][tag2];
      if (tag1 == tag2) {
        if (flags.matchNERIncentive)         factor*=-1;
 else         factor=0;
      }
      p+=olength * factor;
    }
  }
  return p;
}
