{
  classifier.setWeight("bias",-0.7);
  classifier.setWeight("anaphorSeen",-2);
  classifier.setWeight("max-ranking",2);
  classifier.setWeight("bias-single",-0.7);
  classifier.setWeight("anaphorSeen-single",-2);
  classifier.setWeight("max-ranking-single",2);
  String outputPath=StatisticalCorefTrainer.clusteringModelsPath + modelName + "/";
  File outDir=new File(outputPath);
  if (!outDir.exists()) {
    outDir.mkdir();
  }
  PrintWriter progressWriter;
  List<ClustererDoc> trainDocs;
  List<ClustererDoc> validateDocs;
  try {
    PrintWriter configWriter=new PrintWriter(outputPath + "config","UTF-8");
    configWriter.print(StatisticalCorefUtils.fieldValues(this));
    configWriter.close();
    progressWriter=new PrintWriter(outputPath + "progress","UTF-8");
    Redwood.log("scoref.train","Loading training data");
    StatisticalCorefTrainer.setDataPath("dev",false);
    trainDocs=ClustererDataLoader.loadDocuments(MAX_DOCS);
    validateDocs=new ArrayList<>();
  }
 catch (  Exception e) {
    throw new RuntimeException("Error setting up training",e);
  }
  double bestTrain=0;
  double bestTrainValidate=0;
  double bestValidate=0;
  List<List<Pair<CandidateAction,CandidateAction>>> examples=new ArrayList<>();
  for (int iteration=0; iteration < RETRAIN_ITERATIONS; iteration++) {
    Redwood.log("scoref.train","ITERATION " + iteration);
    classifier.printWeightVector(null);
    Redwood.log("scoref.train","");
    try {
      classifier.writeWeights(outputPath + "model");
      classifier.printWeightVector(IOUtils.getPrintWriter(outputPath + "weights"));
    }
 catch (    Exception e) {
      throw new RuntimeException();
    }
    long start=System.currentTimeMillis();
    Collections.shuffle(trainDocs,random);
    examples=examples.subList(Math.max(0,examples.size() - BUFFER_SIZE_MULTIPLIER * trainDocs.size()),examples.size());
    trainPolicy(examples);
    if (iteration % EVAL_FREQUENCY == 0) {
      double trainScore=evaluatePolicy(trainDocs,true);
      double validateScore=evaluatePolicy(validateDocs,false);
      if (trainScore > bestTrain) {
        bestTrain=trainScore;
        bestTrainValidate=validateScore;
        writeModel("best",outputPath);
      }
      if (validateScore > bestValidate) {
        bestValidate=validateScore;
        writeModel("best_val",outputPath);
      }
      if (iteration % 10 == 0) {
        writeModel("iter_" + iteration,outputPath);
      }
      writeModel("last",outputPath);
      double timeElapsed=(System.currentTimeMillis() - start) / 1000.0;
      double ffhr=State.ffHits / (double)(State.ffHits + State.ffMisses);
      double shr=State.sHits / (double)(State.sHits + State.sMisses);
      double fhr=featuresCacheHits / (double)(featuresCacheHits + featuresCacheMisses);
      Redwood.log("scoref.train",modelName);
      Redwood.log("scoref.train",String.format("Best train: %.4f",bestTrain));
      Redwood.log("scoref.train",String.format("Best validate: %.4f %.4f",bestTrainValidate,bestValidate));
      Redwood.log("scoref.train",String.format("Time elapsed: %.2f",timeElapsed));
      Redwood.log("scoref.train",String.format("Cost hit rate: %.4f",ffhr));
      Redwood.log("scoref.train",String.format("Score hit rate: %.4f",shr));
      Redwood.log("scoref.train",String.format("Features hit rate: %.4f",fhr));
      Redwood.log("scoref.train","");
      progressWriter.write(iteration + " " + trainScore+ " "+ validateScore+ " "+ timeElapsed+ " "+ ffhr+ " "+ shr+ " "+ fhr+ "\n");
      progressWriter.flush();
    }
    for (int docInd=0; docInd < trainDocs.size(); docInd++) {
      examples.add(runPolicy(trainDocs.get(docInd),Math.pow(EXPERT_DECAY,(iteration + 1))));
    }
  }
  progressWriter.close();
}
