{
  if (derivative == null) {
    derivative=new double[domainDimension()];
  }
  to2D(x,weights);
  setWeights(weights);
  List<Integer> docIDs=new ArrayList<Integer>(batch.length);
  for (int m=0; m < batch.length; m++)   docIDs.add(batch[m]);
  multiThreadGradient(docIDs,true);
  int index=0;
  for (int i=0; i < E.length; i++) {
    for (int j=0; j < E[i].length; j++) {
      derivative[index++]=(E[i][j] - Ehat[i][j]);
    }
  }
}
