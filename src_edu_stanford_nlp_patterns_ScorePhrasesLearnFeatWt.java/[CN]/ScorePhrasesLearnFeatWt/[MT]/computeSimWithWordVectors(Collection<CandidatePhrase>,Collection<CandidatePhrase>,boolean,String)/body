{
  Counter<CandidatePhrase> sims=new ClassicCounter<CandidatePhrase>(candidatePhrases.size());
  for (  CandidatePhrase p : candidatePhrases) {
    Map<String,double[]> simsAvgMaxAllLabels=similaritiesWithLabeledPhrases.get(p.getPhrase());
    if (simsAvgMaxAllLabels == null)     simsAvgMaxAllLabels=new HashMap<String,double[]>();
    double[] simsAvgMax=simsAvgMaxAllLabels.get(label);
    if (simsAvgMax == null) {
      simsAvgMax=new double[Similarities.values().length];
      Arrays.fill(simsAvgMax,0);
    }
    if (wordVectors.containsKey(p.getPhrase()) && (!ignoreWordRegex || !PatternFactory.ignoreWordRegex.matcher(p.getPhrase()).matches())) {
      double[] d1=wordVectors.get(p.getPhrase());
      double finalSimScore=0;
      double allsum=0;
      double max=Double.MIN_VALUE;
      boolean donotuse=false;
      for (      CandidatePhrase pos : otherPhrases) {
        if (p.equals(pos)) {
          donotuse=true;
          break;
        }
        if (!wordVectors.containsKey(pos.getPhrase()))         continue;
        double sim;
        PhrasePair pair=new PhrasePair(p.getPhrase(),pos.getPhrase());
        if (cacheSimilarities.containsKey(pair))         sim=cacheSimilarities.getCount(pair);
 else {
          double[] d2=wordVectors.get(pos.getPhrase());
          double sum=0;
          double d1sq=0;
          double d2sq=0;
          for (int i=0; i < d1.length; i++) {
            sum+=d1[i] * d2[i];
            d1sq+=d1[i] * d1[i];
            d2sq+=d2[i] * d2[i];
          }
          sim=sum / (Math.sqrt(d1sq) * Math.sqrt(d2sq));
          cacheSimilarities.setCount(pair,sim);
        }
        if (sim > finalSimScore)         finalSimScore=sim;
        allsum+=sim;
        if (sim > max)         max=sim;
      }
      double prevNumItems=simsAvgMax[Similarities.NUMITEMS.ordinal()];
      double prevAvg=simsAvgMax[Similarities.AVGSIM.ordinal()];
      double prevMax=simsAvgMax[Similarities.MAXSIM.ordinal()];
      double newNumItems=prevNumItems + otherPhrases.size();
      double newAvg=(prevAvg * prevNumItems + allsum) / (newNumItems);
      double newMax=prevMax > max ? prevMax : max;
      simsAvgMax[Similarities.NUMITEMS.ordinal()]=newNumItems;
      simsAvgMax[Similarities.AVGSIM.ordinal()]=newAvg;
      simsAvgMax[Similarities.MAXSIM.ordinal()]=newMax;
      if (!donotuse) {
        sims.setCount(p,finalSimScore);
      }
    }
 else {
      sims.setCount(p,Double.MIN_VALUE);
    }
  }
  return sims;
}
