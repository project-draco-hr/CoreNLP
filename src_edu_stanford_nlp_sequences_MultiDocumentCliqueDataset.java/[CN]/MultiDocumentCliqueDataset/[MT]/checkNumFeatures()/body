{
  if (flags.purgeFeatures > 0 && metaInfo.numFeatures() > flags.purgeFeatures) {
    int[] counts=new int[metaInfo().numFeatures()];
    for (int docNum=0; docNum < numDocuments(); docNum++) {
      CliqueDataset doc=getDocument(docNum);
      for (int datumNum=0; datumNum < doc.numDatums(); datumNum++) {
        int[] features=doc.features[datumNum].get(doc.maxCliqueLabels[datumNum]).features;
        for (int featureNum=0; featureNum < features.length; featureNum++) {
          counts[features[featureNum]]++;
        }
      }
    }
    boolean[] featuresToKeep=new boolean[counts.length];
    for (int i=0; i < featuresToKeep.length; i++) {
      featuresToKeep[i]=(counts[i] > 1);
    }
    HashIndex newFeatureIndex;
    if (metaInfo.hasOldStyleFeatureIndex()) {
      newFeatureIndex=metaInfo().getOldStyleFeatureIndex();
    }
 else {
      newFeatureIndex=new HashIndex();
    }
    for (int i=0; i < featuresToKeep.length; i++) {
      if (featuresToKeep[i]) {
        newFeatureIndex.add(metaInfo().getFeature(i));
      }
    }
    for (int docNum=0; docNum < numDocuments(); docNum++) {
      CliqueDataset doc=getDocument(docNum);
      for (int datumNum=0; datumNum < doc.numDatums(); datumNum++) {
        for (        LabeledClique lc : doc.features[datumNum].keySet()) {
          Features featureInfo=doc.features[datumNum].get(lc);
          int[] features=featureInfo.features;
          double[] values=new double[features.length];
          int num=0;
          for (int featureNum=0; featureNum < features.length; featureNum++) {
            if (featuresToKeep[features[featureNum]]) {
              num++;
            }
          }
          boolean isBoolean=featureInfo.isBoolean();
          int index=0;
          for (int featureNum=0; featureNum < features.length; featureNum++) {
            int newIndex=newFeatureIndex.indexOf(metaInfo().getFeature(features[featureNum]));
            if (newIndex >= 0) {
              features[index]=newIndex;
              if (!isBoolean) {
                values[index]=featureInfo.value(featureNum);
              }
              index++;
            }
          }
          int[] newFeatures=new int[index];
          System.arraycopy(features,0,newFeatures,0,index);
          featureInfo.features=newFeatures;
          float[] newValues=null;
          if (!isBoolean) {
            newValues=new float[index];
            System.arraycopy(values,0,newValues,0,index);
            featureInfo.setValues(newValues);
          }
        }
      }
    }
    metaInfo().setFeatureIndex(newFeatureIndex);
  }
}
