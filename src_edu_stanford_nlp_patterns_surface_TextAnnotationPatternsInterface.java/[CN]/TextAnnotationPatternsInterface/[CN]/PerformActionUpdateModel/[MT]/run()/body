{
  PrintWriter out=null;
  String msg="";
  BufferedReader in=null;
  try {
    in=new BufferedReader(new InputStreamReader(socket.getInputStream()));
    out=new PrintWriter(socket.getOutputStream(),true);
  }
 catch (  IOException e) {
    try {
      socket.close();
    }
 catch (    IOException e1) {
      e1.printStackTrace();
    }
    e.printStackTrace();
  }
  out.println("The possible actions are " + Arrays.toString(Actions.values()) + ".Enter a line with only a period to quit");
  Actions nextlineAction=Actions.NONE;
  while (true) {
    try {
      String line=in.readLine();
      if (line == null || line.equals(".")) {
        break;
      }
      String[] toks=line.split("###");
      try {
        nextlineAction=Actions.valueOf(toks[0].trim());
      }
 catch (      IllegalArgumentException e) {
        System.out.println("read " + toks[0] + " and cannot understand");
        msg="Did not understand " + toks[0] + ". POSSIBLE ACTIONS ARE: "+ Arrays.toString(Actions.values());
      }
      String input=toks.length == 2 ? toks[1] : null;
      if (nextlineAction.equals(Actions.NEWPHRASES)) {
        msg=doNewPhrases(input);
      }
 else       if (nextlineAction.equals(Actions.NEWANNOTATIONS)) {
        msg=doNewAnnotations(input);
      }
 else       if (nextlineAction.equals(Actions.REMOVEPHRASES)) {
        msg=doRemovePhrases(input);
      }
 else       if (nextlineAction.equals(Actions.PROCESSFILE)) {
        msg=processFile(input);
      }
 else       if (nextlineAction.equals(Actions.SUMMARY)) {
        msg=this.currentSummary();
      }
 else       if (nextlineAction.equals(Actions.SUGGEST)) {
        msg=this.suggestPhrases();
      }
 else       if (nextlineAction.equals(Actions.MATCHEDTOKENSBYALL)) {
        msg=this.getMatchedTokensByAllPhrases();
      }
 else       if (nextlineAction.equals(Actions.MATCHEDTOKENSBYPHRASE)) {
        msg=this.getMatchedTokensByPhrase(input);
      }
 else       if (nextlineAction.equals(Actions.CLOSE)) {
        msg="bye!";
      }
      System.out.println("sending msg " + msg);
    }
 catch (    Exception e) {
      msg="ERROR " + e.toString().replaceAll("\n","\t") + ". REDO.";
      nextlineAction=Actions.NONE;
      log("Error handling client# " + clientNumber);
      e.printStackTrace();
    }
 finally {
      out.println(msg);
    }
  }
}
