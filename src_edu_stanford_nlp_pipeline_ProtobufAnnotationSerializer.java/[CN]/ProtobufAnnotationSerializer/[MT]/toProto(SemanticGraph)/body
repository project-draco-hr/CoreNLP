{
  CoreNLPProtos.DependencyGraph.Builder builder=CoreNLPProtos.DependencyGraph.newBuilder();
  Set<Integer> rootSet=new IdentityHashSet<>();
  for (  IndexedWord root : graph.getRoots()) {
    rootSet.add(root.index());
  }
  for (  IndexedWord node : graph.vertexSet()) {
    CoreNLPProtos.DependencyGraph.Node.Builder nodeBuilder=CoreNLPProtos.DependencyGraph.Node.newBuilder().setSentenceIndex(node.get(SentenceIndexAnnotation.class)).setIndex(node.index());
    if (node.containsKey(CopyAnnotation.class)) {
      nodeBuilder.setCopyAnnotation(node.get(CopyAnnotation.class));
    }
    builder.addNode(nodeBuilder.build());
    if (rootSet.contains(node.index())) {
      builder.addRoot(node.index());
    }
  }
  for (  SemanticGraphEdge edge : graph.edgeIterable()) {
    builder.addEdge(CoreNLPProtos.DependencyGraph.Edge.newBuilder().setSource(edge.getSource().index()).setTarget(edge.getTarget().index()).setDep(edge.getRelation().toString()).setIsExtra(edge.isExtra()).setSourceCopy(edge.getSource().copyCount()).setTargetCopy(edge.getTarget().copyCount()).setLanguage(toProto(edge.getRelation().getLanguage())));
  }
  return builder.build();
}
