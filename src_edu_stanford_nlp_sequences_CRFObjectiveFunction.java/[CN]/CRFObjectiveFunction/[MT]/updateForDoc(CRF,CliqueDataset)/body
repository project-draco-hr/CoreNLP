{
  model.setParameters(weights);
  for (int datumNum=0; datumNum < doc.features.length; datumNum++) {
    LabeledClique trueMaxCliqueLabel=doc.maxCliqueLabels[datumNum];
    List<LabeledClique> otherLabels=doc.getMaxCliqueLabels(datumNum);
    int size=otherLabels.size();
    for (int i=0; i < size; i++) {
      LabeledClique otherLC=otherLabels.get(i);
      double prob=model.probOf(datumNum,otherLC);
      if (Double.isNaN(prob)) {
        System.err.println("---------------------");
        System.err.println(datumNum);
        System.err.println(otherLC);
        System.err.println(prob);
        System.err.println(model.logProbOf(datumNum,otherLC));
        System.err.println("---------------------");
      }
      Features p=doc.features[datumNum].get(otherLC);
      int[] features=p.features;
      for (int featureIndex=0; featureIndex < features.length; featureIndex++) {
        E[features[featureIndex]]+=prob * p.value(featureIndex);
      }
    }
    value-=model.logProbOf(datumNum,trueMaxCliqueLabel);
  }
  model.clearFactors();
}
