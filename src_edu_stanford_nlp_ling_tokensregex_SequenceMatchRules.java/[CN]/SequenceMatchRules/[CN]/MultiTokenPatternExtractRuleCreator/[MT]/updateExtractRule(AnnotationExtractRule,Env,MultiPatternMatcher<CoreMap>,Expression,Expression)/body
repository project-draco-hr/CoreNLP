{
  MatchedExpression.SingleAnnotationExtractor valueExtractor=createAnnotationExtractor(env,r);
  if (r.annotationField != null && r.annotationField != CoreMap.class) {
    valueExtractor.valueExtractor=new CoreMapFunctionApplier<List<? extends CoreMap>,Value>(env,r.annotationField,new MultiSequencePatternExtractRule<CoreMap,Value>(pattern,new SequenceMatchResultExtractor<CoreMap>(env,action,result)));
    r.extractRule=new CoreMapExtractRule<List<? extends CoreMap>,MatchedExpression>(env,r.annotationField,new MultiSequencePatternExtractRule<CoreMap,MatchedExpression>(pattern,new SequenceMatchedExpressionExtractor(valueExtractor,r.matchedExpressionGroup)));
  }
 else {
    valueExtractor.valueExtractor=new CoreMapToListFunctionApplier<Value>(env,new MultiSequencePatternExtractRule<CoreMap,Value>(pattern,new SequenceMatchResultExtractor<CoreMap>(env,action,result)));
    r.extractRule=new CoreMapToListExtractRule<MatchedExpression>(new MultiSequencePatternExtractRule<CoreMap,MatchedExpression>(pattern,new SequenceMatchedExpressionExtractor(valueExtractor,r.matchedExpressionGroup)));
  }
  r.filterRule=new AnnotationMatchedFilter(valueExtractor);
  r.pattern=pattern;
  r.result=result;
}
