{
  int numTokens=0;
  boolean printing=parseInsideBegin == null;
  boolean beginLine=true;
  for (PTBTokenizer<CoreLabel> tokenizer=new PTBTokenizer<CoreLabel>(r,new CoreLabelTokenFactory(),options); tokenizer.hasNext(); ) {
    CoreLabel obj=tokenizer.next();
    String origStr=obj.get(TextAnnotation.class);
    String str;
    if (lowerCase) {
      str=origStr.toLowerCase(Locale.ENGLISH);
      obj.set(TextAnnotation.class,str);
    }
 else {
      str=origStr;
    }
    if (parseInsideBegin != null && parseInsideBegin.matcher(origStr).matches()) {
      printing=true;
    }
 else     if (parseInsideEnd != null && parseInsideEnd.matcher(origStr).matches()) {
      printing=false;
    }
 else     if (printing) {
      if (dump) {
        str=obj.toString();
      }
      if (preserveLines) {
        if (PTBLexer.NEWLINE_TOKEN.equals(origStr)) {
          beginLine=true;
          writer.newLine();
        }
 else {
          if (!beginLine) {
            writer.write(' ');
          }
 else {
            beginLine=false;
          }
          writer.write(str);
        }
      }
 else {
        writer.write(str);
        writer.newLine();
      }
    }
    numTokens++;
  }
  return numTokens;
}
