{
  HashIndex newFeatureIndex=new HashIndex();
  for (int i=0; i < featuresToKeep.length; i++) {
    if (featuresToKeep[i]) {
      newFeatureIndex.add(data.metaInfo().getFeature(i));
    }
  }
  for (int docNum=0; docNum < data.numDocuments(); docNum++) {
    CliqueDataset doc=data.getDocument(docNum);
    for (int datumNum=0; datumNum < doc.numDatums(); datumNum++) {
      for (      LabeledClique lc : doc.features[datumNum].keySet()) {
        Features featureInfo=doc.features[datumNum].get(lc);
        int[] features=featureInfo.features;
        int num=0;
        for (int featureNum=0; featureNum < features.length; featureNum++) {
          if (featuresToKeep[features[featureNum]]) {
            num++;
          }
        }
        int[] newFeatures=new int[num];
        float[] newValues=null;
        boolean isBoolean=featureInfo.isBoolean();
        if (!isBoolean) {
          newValues=new float[num];
        }
        int index=0;
        for (int featureNum=0; featureNum < features.length; featureNum++) {
          if (featuresToKeep[features[featureNum]]) {
            newFeatures[index]=newFeatureIndex.indexOf(data.metaInfo().getFeature(features[featureNum]));
            if (!isBoolean) {
              newValues[index]=featureInfo.value(featureNum);
            }
            index++;
          }
        }
        featureInfo.features=newFeatures;
        if (!isBoolean) {
          featureInfo.setValues(newValues);
        }
      }
    }
  }
  data.metaInfo().setFeatureIndex(newFeatureIndex);
  data.printStats(new PrintWriter(System.err,true));
}
